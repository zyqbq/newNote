# Three.js着色器——光照计算

为了更好的渲染效果，一般都会对网格模型进行光照计算,光照计算的相关算法是对生活中光线漫反射、镜面反射等光学现象的模拟，如果你不了解光照计算的一些算法可以去学习一下原生的WebGL教程和图形学方面的知识。

前面说过Three.js的材质对象本质上都是着色器代码，有些材质支持光照计算，有些材质不支持光照计算，比如基础网格材质`MeshBasicMaterial`,有些材质支持光照计算，支持光照计算的材质具体的算法也不尽相同,兰伯特网格材质`MeshPhongMaterial`、高光网格材质`MeshPhongMaterial`、标准网格材质`MeshStandardMaterial` 。

## 平行光模型

本节课通过一个平行光的案例来进一步让大家认识着色器材质对象ShaderMaterial的使用。

### 顶点着色器

##### 系统自动声明的变量

使用ShaderMaterial构造函数自定义着色器的时候,顶点法向量变量`normal`和顶点位置变量'position'一样不用手动声明，Three.js渲染器系统会通过WebGLPrograms.js模块自动声明`attribute vec3 normal;`。

- `geometry.attributes.position`对应着色器中`position`变量
- `geometry.attributes.normal`对应着色器中`normal`变量

```JavaScript
var geometry = new THREE.BoxBufferGeometry(0.5, 0.5, 0.5);
    // 查看几何体的顶点位置、顶点法向量数据
    console.log(geometry.attributes);
    
```

法向量矩阵`normalMatrix`和模型矩阵`modelMatrix`一样不需要手动声明系统会自动声明，可以直接在main函数中使用。顶点的位置进行了旋转等变换，顶点的法向量方向肯定会发生变化，所以需要一个法向量矩阵对顶点法向量进行变换，Threejs渲染器模块会根据顶点位置的相关变换矩阵计算`normalMatrix`的值。

```JavaScript
<script id="vertexShader" type="x-shader/x-vertex">
      //varying声明顶点法向量插值后变量
      varying vec3 v_normal;
      void main(){
        // normalMatrix法向量矩阵：模型的顶点进行了模型变换，顶点的法向量要跟着变化
        // 顶点的法向量执行插值计算
        v_normal=normalMatrix*normal;
        // 模型矩阵modelMatrix
        gl_Position = modelMatrix*vec4( position, 1.0 );
      }
    </script>
    
```

### 片元着色器

片元着色器代码中包含了平行光漫反射计算的光照模型算法。光线的入射角不同反射的强度不同，一个立方的表面法线方向不相同，与平行光的夹角不同，每个面的明暗就不同。关于光照模型更多的知识可以学习原生WebGL教程和图形学。

```JavaScript
<script id="fragmentShader" type="x-shader/x-fragment">
      // 声明一个颜色变量表示网格模型颜色
      uniform vec3 u_color;
      // 顶点法向量插值后的结果，一个片元数据对应一个法向量数据
      varying vec3 v_normal;
      // uniform声明平行光颜色变量
      uniform vec3 u_lightColor;
      //平行光方向变量
      uniform vec3 u_lightDirection;
      void main() {
        // 法向量归一化
        vec3 norlmal2 = normalize(v_normal);
        // 计算平行光方向向量和片元法向量的点积
        // 不同的入射角度反射强度不同
        float dot = dot(u_lightDirection, norlmal2);
        // 计算反射后的颜色  光线颜色*物体颜色*dot
        vec3 reflectedLight = u_lightColor * u_color * dot;
        // 反射颜色赋值给内置变量gl_FragColor
        gl_FragColor = vec4(reflectedLight,1.0);
      }
    </script>
    
```

### uniforms定义

```JavaScript
// 定义材质对象的uniforms属性，传递着色器中uniform变量对应的值
    uniforms: {
      // 网格模型颜色
      u_color: {
        value: new THREE.Color(0xff0000)
      },
      // 平行光光源颜色
      u_lightColor: {
        value: new THREE.Color(0xffffff)
      },
      // 平行光的方向
      u_lightDirection: {
        value: new THREE.Vector3(-1.0, -1.0, 1.0).normalize()
      },
    },
    
```